<!DOCTYPE html>
<html>
<head>
	<title>IDP Tool - AnyCompany</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 20px;
		}
		h1 {
			text-align: center;
			font-style: bold;
		}

		h2 {
			text-align: center;
			font-style: italic;
		}
		h3 {
			text-align: left;
			font-style: normal;
			font-size: 12px;
		}

		h4 {
			text-align: center;
			font-style: normal;
			font-size: 11px;
		}

		h5 {
			font-style: light;
			font-size: 10px;
		}
		
		form {
			max-width: 400px;
			margin: 0 auto;
			padding: 20px;
			border: 1px solid #ccc;
			border-radius: 5px;
		}
		label {
			display: block;
			margin-bottom: 10px;
		}
		input[type="text"], input[type="number"] {
			width: 100%;
			padding: 5px;
			margin-bottom: 10px;
			border: 1px solid #ccc;
			border-radius: 3px;
		}
		input[type="checkbox"] {
			margin-bottom: 10px;
		}
		button {
			width: 100%;
			padding: 10px;
			background-color: #FF9900;
			color: black;
			border: none;
			border-radius: 3px;
			cursor: pointer;
			font-style: bold;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			font-size: 14px;
		}

		input {
  			margin-bottom: 10px; /* Add some spacing between inputs */
		}

		img {
    	object-fit: contain;
		}

	</style>
</head>
<body>
	<h1>Intelligent Document Procesing Tool</h1>
	<h2> Upload and Classify</h2>


	<form>
		<div style="display: flex; flex-direction: column;">
	
			<h3>Customer</h3>
			<input type="text" id="customer" placeholder="Enter customer name" required>
	
			<h3>Year-Month</h3>
			<input type="text" id="year-month" placeholder="Enter year-month (YYYY-MM)" required>
	
			<h3>Document Name</h3>
			<input type="text" id="object-name" placeholder="Enter document name" disabled>
	
			<h3>File to import:</h3>
			<input id="file-input" type="file" accept=".pdf,.jpeg,.png,.tiff" multiple required>
			<br>
			<br>
			<br>
	
			<h4>NOTE: File must be pdf, jpeg, png, tiff extension.</h4> </br>
			<br>
			<br>
	
			<button type="button" id="upload-button">Upload and process file</button>
	
			<div style="display: flex; flex-direction: column; align-items: flex-end;">
				<h5 style="margin-bottom: 5px;">Powered by:</h5>
				<img alt="AWSIcon" width="60px" src="#" />
			</div>
	
		</div>
	</form>

	<script>
async function getPresignedUrl(objectName, customer, yearMonth) {
    const dateTime = new Date().toISOString().replace(/:/g, '-');
    const params = new URLSearchParams({
        object_name: objectName,
        customer: customer,
        year_month: yearMonth,
        date_time: dateTime
    });

    try {
        const response = await fetch(`https://7da9mwsko7.execute-api.us-east-2.amazonaws.com/upload?${params.toString()}`, {
            method: 'PUT',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        const responseText = await response.text();
        const responseJson = JSON.parse(responseText);

        if (responseJson.statusCode === 400 && responseJson.body === '"El documento ya existe"') {
            throw new Error('DUPLICATE_DOCUMENT');
        }

        if (responseJson.statusCode !== 200) {
            throw new Error(`HTTP error! status: ${responseJson.statusCode}`);
        }

        const innerJson = JSON.parse(responseJson.body);
        if (innerJson.url) {
            return innerJson.url;
        } else {
            throw new Error('Presigned URL not found in response');
        }
    } catch (error) {
        console.error('Error in getPresignedUrl:', error);
        throw error;
    }
}


		
async function uploadFile(event) {
    event.preventDefault();

    const customer = document.getElementById('customer').value.trim();
    const yearMonth = document.getElementById('year-month').value.trim();
    const fileInputElement = document.getElementById('file-input');
    const files = fileInputElement.files;

    if (!customer || !yearMonth || files.length === 0) {
        alert('Please fill in all fields and select at least one file.');
        return;
    }

    const uploadButton = event.target;
    uploadButton.disabled = true;
    uploadButton.textContent = 'Uploading...';

    try {
        for (const file of files) {
            const objectName = file.name;
            document.getElementById('object-name').value = objectName;

            try {
                const presignedUrl = await getPresignedUrl(objectName, customer, yearMonth);

                const response = await fetch(presignedUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to upload ${objectName}. Status: ${response.status}`);
                }

                console.log(`File ${objectName} uploaded successfully!`);
            } catch (error) {
                if (error.message === 'DUPLICATE_DOCUMENT') {
                    console.warn(`File ${objectName} is a duplicate and was not uploaded.`);
                    alert(`The document "${objectName}" already exists and will not be uploaded.`);
                } else {
                    throw error; // Re-throw the error if it's not a duplicate document error
                }
            }
        }

        alert('Upload process completed. Check the console for details on each file.');
    } catch (error) {
        console.error('Error during file upload:', error);
        alert(`Error: ${error.message}`);
    } finally {
        uploadButton.disabled = false;
        uploadButton.textContent = 'Upload and process file';
    }
}

		
		// Add event listener when the DOM is fully loaded
		document.addEventListener('DOMContentLoaded', function() {
			const uploadButton = document.getElementById('upload-button');
			if (uploadButton) {
				uploadButton.addEventListener('click', uploadFile);
			} else {
				console.error('Upload button not found');
			}
		});
		</script>
		
</body>
</html>
