<!DOCTYPE html>
<html>
<head>
    <title>IDP Tool - AnyCompany</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
            font-style: bold;
        }
        h2 {
            text-align: center;
            font-style: italic;
        }
        h3 {
            text-align: left;
            font-style: normal;
            font-size: 12px;
        }
        h4 {
            text-align: center;
            font-style: normal;
            font-size: 11px;
        }
        h5 {
            font-style: light;
            font-size: 10px;
        }
        form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        input[type="checkbox"] {
            margin-bottom: 10px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #FF9900;
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-style: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        input {
              margin-bottom: 10px; /* Add some spacing between inputs */
        }
        img {
            object-fit: contain;
        }
        #upload-status {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        #sns-messages, #dynamo-results {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .additional-sections {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .additional-section {
            width: 48%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }
        .additional-section h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Intelligent Document Processing Tool</h1>
    <h2>Upload and Classify</h2>

    <form>
        <div style="display: flex; flex-direction: column;">
            <h3>Customer</h3>
            <input type="text" id="customer" placeholder="Enter customer name" required>
    
            <h3>Year-Month</h3>
            <input type="text" id="year-month" placeholder="Enter year-month (YYYY-MM)" required>
    
            <h3>Upload Status</h3>
            <div id="upload-status"></div>
    
            <h3>File to import:</h3>
            <input id="file-input" type="file" accept=".pdf,.jpeg,.png,.tiff" multiple required>
            <br>
            <br>
            <br>
    
            <h4>NOTE: File must be pdf, jpeg, png, tiff extension.</h4>
            <br>
            <br>
    
            <button type="button" id="upload-button">Upload and process file</button>
    
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <h5 style="margin-bottom: 5px;">Powered by:</h5>
                <img alt="AWSIcon" width="60px" src="#" />
            </div>
        </div>
    </form>

    <div class="additional-sections">
        <div class="additional-section">
            <h2>Mensajes de SNS</h2>
            <div id="sns-messages"></div>
            <button id="subscribe-sns" disabled>Suscribirse a SNS</button>
        </div>
        <div class="additional-section">
            <h2>Consultar DynamoDB</h2>
            <div>
                <label for="customer-query">Customer:</label>
                <input type="text" id="customer-query" placeholder="Ingresa el customer">
            </div>
            <div>
                <label for="year-month-query">Year-Month:</label>
                <input type="text" id="year-month-query" placeholder="Ingresa el year-month (YYYY-MM)">
            </div>
            <button id="query-dynamo">Consultar</button>
            <br>
            <br>
            <button id="scan-dynamo">Escanear Tabla</button>
            <div id="dynamo-results"></div>
        </div>
    </div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1313.0.min.js"></script>
    <script>
        // Configurar AWS SDK
        AWS.config.region = 'tu-region'; // Reemplaza con tu región
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'tu-identity-pool-id' // Reemplaza con tu ID de pool de identidades
        });

        // Inicializar clientes de AWS
        const sns = new AWS.SNS();
        const dynamodb = new AWS.DynamoDB();

        // Función para suscribirse al tema de SNS
        const subscribeToSNS = async () => {
            // Lógica para suscribirse al tema de SNS
        };

        // Función para recibir mensajes de SNS
        const startReceivingMessages = () => {
            // Lógica para recibir mensajes de SNS
        };

        // Función para consultar DynamoDB
        const queryDynamoDB = async () => {
            const customerQuery = document.getElementById('customer-query').value;
            const yearMonthQuery = document.getElementById('year-month-query').value;
            const resultsDiv = document.getElementById('dynamo-results');

            const params = {
                TableName: 'tu-tabla-dynamodb', // Reemplaza con el nombre de tu tabla de DynamoDB
                FilterExpression: '#customer = :customer AND #yearMonth = :yearMonth',
                ExpressionAttributeNames: {
                    '#customer': 'customer',
                    '#yearMonth': 'year_month'
                },
                ExpressionAttributeValues: {
                    ':customer': customerQuery,
                    ':yearMonth': yearMonthQuery
                }
            };

            if (!customerQuery && !yearMonthQuery) {
                // Realizar un escaneo completo de la tabla
                params.FilterExpression = undefined;
                params.ExpressionAttributeNames = undefined;
                params.ExpressionAttributeValues = undefined;
            } else if (!customerQuery) {
                // Consultar solo por Year-Month
                params.FilterExpression = '#yearMonth = :yearMonth';
                delete params.ExpressionAttributeNames['#customer'];
                delete params.ExpressionAttributeValues[':customer'];
            } else if (!yearMonthQuery) {
                // Consultar solo por Customer
                params.FilterExpression = '#customer = :customer';
                delete params.ExpressionAttributeNames['#yearMonth'];
                delete params.ExpressionAttributeValues[':yearMonth'];
            }

            try {
                const data = await dynamodb.scan(params).promise();
                resultsDiv.innerHTML = '';
                data.Items.forEach(item => {
                    const itemDiv = document.createElement('pre');
                    itemDiv.textContent = JSON.stringify(item, null, 2);
                    resultsDiv.appendChild(itemDiv);
                });
            } catch (err) {
                console.error('Error al consultar DynamoDB:', err);
            }
        };

        // Función para realizar un escaneo completo de la tabla de DynamoDB
        const scanDynamoDB = async () => {
            const resultsDiv = document.getElementById('dynamo-results');

            const params = {
                TableName: 'tu-tabla-dynamodb' // Reemplaza con el nombre de tu tabla de DynamoDB
            };

            try {
                const data = await dynamodb.scan(params).promise();
                resultsDiv.innerHTML = '';
                data.Items.forEach(item => {
                    const itemDiv = document.createElement('pre');
                    itemDiv.textContent = JSON.stringify(item, null, 2);
                    resultsDiv.appendChild(itemDiv);
                });
            } catch (err) {
                console.error('Error al escanear DynamoDB:', err);
            }
        };

        // Eventos
        document.getElementById('subscribe-sns').addEventListener('click', subscribeToSNS);
        document.getElementById('query-dynamo').addEventListener('click', queryDynamoDB);
        document.getElementById('scan-dynamo').addEventListener('click', scanDynamoDB);


        // Código existente para subir archivos a S3
        async function getPresignedUrl(objectName, customer, yearMonth) {
            const dateTime = new Date().toISOString().replace(/:/g, '-');
            const params = new URLSearchParams({
                object_name: objectName,
                customer: customer,
                year_month: yearMonth,
                date_time: dateTime
            });

            try {
                const response = await fetch(`https://7da9mwsko7.execute-api.us-east-2.amazonaws.com/upload?${params.toString()}`, {
                    method: 'PUT',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const responseText = await response.text();
                const responseJson = JSON.parse(responseText);

                if (responseJson.statusCode === 400 && responseJson.body === '"El documento ya existe"') {
                    throw new Error('DUPLICATE_DOCUMENT');
                }

                if (responseJson.statusCode !== 200) {
                    throw new Error(`HTTP error! status: ${responseJson.statusCode}`);
                }

                const innerJson = JSON.parse(responseJson.body);
                if (innerJson.url) {
                    return innerJson.url;
                } else {
                    throw new Error('Presigned URL not found in response');
                }
            } catch (error) {
                console.error('Error in getPresignedUrl:', error);
                throw error;
            }
        }

        async function uploadFile(event) {
            event.preventDefault();

            const customer = document.getElementById('customer').value.trim();
            const yearMonth = document.getElementById('year-month').value.trim();
            const fileInputElement = document.getElementById('file-input');
            const files = fileInputElement.files;
            const statusDiv = document.getElementById('upload-status');

            if (!customer || !yearMonth || files.length === 0) {
                alert('Please fill in all fields and select at least one file.');
                return;
            }

            const uploadButton = event.target;
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';

            statusDiv.innerHTML = ''; // Clear previous status messages

            try {
                for (const file of files) {
                    const objectName = file.name;
                    const statusElement = document.createElement('p');
                    statusElement.textContent = `Uploading ${objectName}...`;
                    statusDiv.appendChild(statusElement);

                    try {
                        const presignedUrl = await getPresignedUrl(objectName, customer, yearMonth);

                        const response = await fetch(presignedUrl, {
                            method: 'PUT',
                            body: file,
                            headers: {
                                'Content-Type': file.type
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to upload ${objectName}. Status: ${response.status}`);
                        }

                        statusElement.textContent = `${objectName} uploaded successfully!`;
                        statusElement.style.color = 'green';
                    } catch (error) {
                        if (error.message === 'DUPLICATE_DOCUMENT') {
                            statusElement.textContent = `${objectName} is a duplicate and was not uploaded.`;
                            statusElement.style.color = 'orange';
                        } else {
                            statusElement.textContent = `Error uploading ${objectName}: ${error.message}`;
                            statusElement.style.color = 'red';
                        }
                    }
                }

                alert('Upload process completed. Check the status for details on each file.');
            } catch (error) {
                console.error('Error during file upload:', error);
                alert(`Error: ${error.message}`);
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload and process file';
            }
        }

        // Add event listener when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const uploadButton = document.getElementById('upload-button');
            if (uploadButton) {
                uploadButton.addEventListener('click', uploadFile);
            } else {
                console.error('Upload button not found');
            }
        });
    </script>
</body>
</html>